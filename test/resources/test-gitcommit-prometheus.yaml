---
apiVersion: gco.galos.one/v1
kind: GitCommit
metadata:
  name: test-gitcommit-prometheus
  namespace: git-change-operator
spec:
  repository: https://github.com/mihaigalos/test.git
  branch: main
  commitMessage: "Smart meter power consumption analysis from Prometheus"
  authSecretRef: git-credentials
  authSecretKey: token
  ttlMinutes: 5
  restAPIs:
    # SCALAR query - result is [timestamp, value]
    - name: "power-consumption"
      url: "https://cloud.galos.one/prometheus/api/v1/query?query=scalar(max(max_over_time(smartmeter%7Bkind%3D%22total_power%22%7D%5B1d%5D))-max(max_over_time(smartmeter%7Bkind%3D%22total_power%22%7D%5B1d%5D%20offset%201d)))"
      method: "GET"
      timeoutSeconds: 30
      maxStatusCode: 299
      responseParsing:
        condition: 'response.status == "success" && response.data.resultType == "scalar" && size(response.data.result) == 2'
        # For scalar: result[0] = timestamp, result[1] = value with NaN handling 
        dataExpression: 'string(timestamp(int(double(response.data.result[0])))) + ", " + (response.data.result[1] == "NaN" ? "No Data" : string(double(response.data.result[1])))'
        outputFormat: 'data'

    # SCALAR query - result is [timestamp, value]
    - name: "injected-power"
      url: "https://cloud.galos.one/prometheus/api/v1/query?query=scalar(max(max_over_time(smartmeter%7Bkind%3D%22total_powerN%22%7D%5B1d%5D%20offset%20-1d))-min(min_over_time(smartmeter%7Bkind%3D%22total_powerN%22%7D%5B1d%5D%20offset%20-1d)))"
      method: "GET"
      timeoutSeconds: 30
      maxStatusCode: 299
      responseParsing:
        condition: 'response.status == "success" && response.data.resultType == "scalar" && size(response.data.result) == 2'
        # For scalar: just the value part
        dataExpression: '(response.data.result[1] == "NaN" ? "0.0" : string(double(response.data.result[1])))'
        outputFormat: 'data'

    # VECTOR query - result is array of objects with .value[timestamp, value]
    - name: "current-power"
      url: "https://cloud.galos.one/prometheus/api/v1/query?query=smartmeter%7Bkind%3D%22total_power%22%7D"
      method: "GET"
      timeoutSeconds: 30
      maxStatusCode: 299
      responseParsing:
        condition: 'response.status == "success" && response.data.resultType == "vector" && size(response.data.result) > 0'
        # For vector: result[0].value[0] = timestamp, result[0].value[1] = value
        dataExpression: 'response.data.result[0].value[1] == "NaN" ? "No Data" : string(double(response.data.result[0].value[1]))'
        outputFormat: 'data'
  files:
    - path: power-readings.csv
      content: "placeholder"
      useRestAPIData: true
      restAPIDelimiter: ", "
      writeMode: "append"
